<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/viewPet.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/icons.css">
    <title>View - </title>
</head>

<body>

    <header>
        <div class="container">
            <div class="lg" style="width: 268px;">
                <a href="./" class="logo">
                    <img src="./imgs/logo.png" alt="pawsafe">
                    <h3>Paws Safe</h3>
                </a>
            </div>
            <ul class="nav">
                <li><a href="./index.html">Home</a></li>
                <li><a href="./foster.html" id="fosterLink">Foster</a></li>
                <li><a href="./rehoming.html" id="rehomeLink">ReHoming</a></li>
                <li><a href="./contactus.html">Contact Us</a></li>
            </ul>
            <div class="auth">
                <div class="register">
                    <a href="./login.html" class="login">Login</a>
                    <a href="./signup.html" class="signup"><i class="fa-solid fa-user"></i> Sign Up</a>
                </div>

                <a href="./postpet.html" class="post_pet d_none"><i class="fa-solid fa-paw"></i> Post Your Pet </a>
                <a href="#" class="logout d_none"><i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="petInfo">
            <div class="img" style="position: relative; overflow: hidden;">
                <img id="img" src="./imgs/adoptsingle1.jpg" alt="">
                <span class="category" id="ra">adoption</span>
            </div>
            <ul class="info">
                <li>
                    <h1 id="name"></h1>
                </li>
                <li>
                    <h4 id="age"></h4>
                </li>
                <li>
                    <div class="loc">
                        <i class="fa-solid fa-location-dot"></i>
                        <span id="location"></span>
                    </div>
                </li>
                <li>
                    <div class="cat">
                        <span style="color: grey;">Category:</span>
                        <span id="cat" style="text-transform: capitalize;"></span>
                    </div>
                </li>
                <li>
                    <div class="medical_history">
                        <span style="color: grey; font-weight: bold;"> Medical history</span>
                        <div class="qa">
                            <div>
                                <p>Vaccinations: </p> <span id="vaccines_prevention"></span>
                            </div>
                            <div>
                                <p>Medical Conditions: </p> <span id="health_history"></span>
                            </div>
                            <div>
                                <p>Diet:</p> <span id="diet"></span>
                            </div>
                            <div>
                                <p>Behavior Issues:</p> <span id="behavior"></span>
                            </div>

                        </div>
                    </div>

                </li>

                <li>
                    <p id="desc"></p>
                </li>

                <li>
                    <!-- <h4>Owner: </h4> -->
                    <div class="user">
                        <p>This pet owenes to <span id="owenrName" style="color: #000;font-weight: bold;">Jhon
                                Dell</span></p>
                        <div class="contact" style="display: flex; align-items: center;gap: 1rem;margin-top: 5px;">
                            <div><span style="color: #454545;">Email: </span> <span
                                    id="ownerEmail">jhon@gmail.com</span>
                            </div>
                            <div><span style="color: #454545;">Phone: </span> <span id="ownerPhone">+2012859678</span>
                            </div>
                        </div>
                    </div>
                </li>

                <!-- FOR ANY USER EXCEPT THE OWNER -->

                <li style="display: flex;align-items: center;gap: 1rem;" id="userRequest" class="d_none">
                    <button id="petButton">Adopt Pet</button>
                    <p>This pet have <span style="font-weight: bold;" id="requestsCount">0</span> requests</p>
                </li>

                <!-- FOR THE OWNER -->

                <li style="display: flex;align-items: center;gap: 1rem;" id="userIdentify" class="d_none">
                    <p>You have <span style="font-weight: bold;" id="requestsCount">0</span> requests on this pet</p>
                </li>

            </ul>



        </div>

        <h1 style="width: 85%; margin: 0 auto;margin-top: 40px;">Requests</h1>
        <div class="requests">
            <!-- <div class="request">
                <div class="user" style="flex-direction: column;align-items: flex-start;">
                    <h3 id="requester">Jhon Dell</h3>
                    <div class="contact" style="margin-top: -10px;">
                        <p style="color: #4b4b4b;">Email: <span id="email" style="color: #000;">jhon@gmail.com</span>
                        </p>
                        <p style="color: #4b4b4b;">Phone: <span id="phone" style="color: #000;">+2012859687</span></p>
                    </div>
                </div>

                <div class="requestCont" style="flex-direction: column;align-items: flex-start;">
                    <div>
                        <p>Are pets allowed in your residence: </p> <span id="household_A">Yes</span>
                    </div>
                    <div>
                        <p>Who else lives in your home: </p> <span id="household_A">Yes</span>
                    </div>
                    <div>
                        <p>Do you currently have other pets: </p> <span id="other_pets_A">Yes</span>
                    </div>
                    <div>
                        <p>Have you owned or cared for pets before: </p> <span id="pet_experience_A">Yes</span>
                    </div>

                    <div>
                        <p>How much time can you dedicate to the pet daily: </p> <span id="time_commitment_A">Yes</span>
                    </div>
                    <div>
                        <p>Are you financially prepared for pet care costs: </p> <span
                            id="financial_prepared_A">Yes</span>
                    </div>
                </div>
            </div> -->

        </div>

    </main>

    <div id="form_popup">
        <div class="content">
            <div id="close">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <h1>Request a Pet</h1>
            <form action="">

                <!-- <div class="input">
                    <label for="location">Where do you live? (City/Region)</label>
                    <input type="text" id="location" name="location" placeholder="Enter your city/region" required>
                </div> -->

                <div class="input">
                    <label for="pets_allowed">Are pets allowed in your residence?</label>
                    <select id="pets_allowed" name="pets_allowed" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                        <option value="not_sure">Not sure</option>
                    </select>
                </div>

                <div class="input">
                    <label for="household">Who else lives in your home?</label>
                    <input type="text" id="household" name="household" placeholder="E.g., adults, children, roommates"
                        required>
                </div>

                <div class="input">
                    <label for="other_pets">Do you currently have other pets?</label>
                    <select id="other_pets" name="other_pets" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="no">No</option>
                        <option value="yes_dog">Yes, a dog</option>
                        <option value="yes_cat">Yes, a cat</option>
                        <option value="yes_other">Yes, other pets</option>
                    </select>
                </div>

                <div class="input">
                    <label for="pet_experience">Have you owned or cared for pets before?</label>
                    <select id="pet_experience" name="pet_experience" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <div class="input" id="foster-duration" style="display: none; text-align: left; ">
                    <label for="foster_duration">How long are you available to foster?</label>
                    <select id="foster_duration" name="foster_duration" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="short_term">Short-term (a few weeks)</option>
                        <option value="long_term">Long-term (several months or more)</option>
                        <option value="emergency">Emergency fostering (temporary care in urgent situations)</option>
                        <option value="not_sure">Not sure yet</option>
                    </select>
                </div>

                <div class="input">
                    <label for="time_commitment">How much time can you dedicate to the pet daily?</label>
                    <input type="text" id="time_commitment" name="time_commitment"
                        placeholder="E.g., 2-3 hours, full-time, etc." required>
                </div>

                <div class="input">
                    <label for="financial_prepared">Are you financially prepared for pet care costs?</label>
                    <select id="financial_prepared" name="financial_prepared" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                        <option value="unsure">Unsure</option>
                    </select>
                </div>

                <!-- Terms and Conditions Section -->
                <div class="input_terms">
                    <input type="checkbox" id="terms" name="terms" required>
                    <label for="terms">
                        I agree to the <a href="terms.html" target="_blank"
                            style="color: #009fff; text-decoration: underline;">Terms and Conditions</a>
                    </label>
                </div>

                <div style="display: flex;flex-direction: column;">
                    <p id="error" class="error d_none" style="font-size: 13px;color: red;">Accept terms and conditions
                    </p>
                    <button id="formRequestBtn">Request</button>
                </div>
            </form>
        </div>
    </div>



    <script>

        function getCookie(name) {
            const cookies = document.cookie.split('; ');
            for (let cookie of cookies) {
                const [key, value] = cookie.split('=');
                if (key === name) {
                    return value;
                }
            }
            return null;
        }



        const userId = getCookie('UserId');
        const urlParams = new URLSearchParams(window.location.search);

        const petId = urlParams.get("petId");

        console.log(petId);

        if (petId) {
            fetch(`http://localhost:400/pet/${petId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data)
                    const pet = data;
                    document.title = `View - ${pet.name}`
                    document.querySelector("#name").textContent = pet.name
                    document.querySelector("#age").textContent = `${pet.age} years old `
                    document.querySelector("#desc").textContent = pet.description
                    document.querySelector("#img").src = pet.img
                    document.querySelector("#vaccines_prevention").textContent = pet.vaccines_prevention
                    document.querySelector("#health_history").textContent = pet.health_history
                    document.querySelector("#diet").textContent = pet.diet
                    document.querySelector("#behavior").textContent = pet.behavior
                    document.querySelector("#location").textContent = `${pet.city} , ${pet.country}`;
                    document.querySelector("#cat").textContent = pet.category
                    document.querySelector("#ra").textContent = pet.foster ? "foster" : "rehoming"
                    document.querySelectorAll("#requestsCount").forEach(ele => {
                        ele.textContent = JSON.parse(pet.requests).length;
                    })

                    document.querySelector("#petButton").textContent = pet.foster ? "Foster Pet" : "Rehome Pet";

                    fetch(`http://localhost:400/users/${userId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            const user = data;
                            const userRequestedPets = JSON.parse(user.requestedPets)
                            userRequestedPets.forEach(requestedPetId => {
                                if (requestedPetId == petId) {
                                    document.querySelector("#petButton").setAttribute("disabled", true)
                                    document.querySelector("#petButton").classList.add("disabled")
                                }
                            })
                        })

                        .catch(error => {
                            console.error("Error fetching users:", error);
                        });

                    // Toggle the foster duration question based on pet type
                    const fosterQuestion = document.querySelector("#foster-duration");
                    if (pet.foster) {
                        fosterQuestion.style.display = "block"; // Show for foster
                    } else {
                        fosterQuestion.style.display = "none"; // Hide for rehome
                    }


                    if (pet.ownerId == userId) {
                        document.querySelector("#userIdentify").classList.remove("d_none")
                    } else {
                        document.querySelector("#userRequest").classList.remove("d_none")
                    }

                    if (pet.foster) {
                        document.querySelector("#fosterLink").classList.add("active")

                    } else if (pet.rehoming) {
                        document.querySelector("#rehomeLink").classList.add("active")
                    }

                    fetch(`http://localhost:400/users/${pet.ownerId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data)
                            const petOwner = data;

                            document.querySelector("#owenrName").textContent = petOwner.username;
                            document.querySelector("#ownerEmail").textContent = petOwner.email;
                            document.querySelector("#ownerPhone").textContent = petOwner.phone;
                        }).catch(error => {
                            console.error("Error fetching users:", error);
                        });

                    // fetching requests 
                    let petRequests = JSON.parse(pet.requests)
                    console.log(petRequests)
                    if (userId == pet.ownerId) {
                        petRequests.reverse().map(request => {
                            fetch(`http://localhost:400/users/${request.authorID}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! Status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log(data)
                                    const author = data
                                    const requestEle = document.createElement("div")
                                    requestEle.innerHTML = `
                                        <div class="request">
                                            <div style="display: flex ; align-items: center; justify-content: space-between;">
                                                <div class="user" style="flex-direction: column;align-items: flex-start;">
                                                    <h3 id="requester">${author.username}</h3>
                                                    <div class="contact" style="margin-top: -10px;">
                                                        <p style="color: #4b4b4b;">Email: <span id="email" style="color: #000;">${author.email}</span>
                                                        </p>
                                                        <p style="color: #4b4b4b;">Phone: <span id="phone" style="color: #000;">${author.phone}</span></p>
                                                    </div>
                                                </div>    
                                                ${pet.ownerId == userId ? `
                                                    <div class="control_request">
                                                        <button>Approve</button>
                                                        <button>Denied</button>
                                                    </div>
                                                `: ""}
                                            </div>

                                            <div class="requestCont" style="flex-direction: column;align-items: flex-start;">
                                                <div>
                                                    <p>Are pets allowed in your residence: </p> <span>${request.petsAllowed}</span>
                                                </div>
                                                <div>
                                                    <p>Who else lives in your home: </p> <span >${request.household}</span>
                                                </div>
                                                <div>
                                                    <p>Do you currently have other pets: </p> <span>${request.otherPets}</span>
                                                </div>
                                                <div>
                                                    <p> How long are you available to foster: </p> <span>${request.fosterDuration}</span>
                                                </div>
                                            
                                                <div>
                                                    <p>Have you owned or cared for pets before: </p> <span>${request.petExperience}</span>
                                                </div>
                                                <div>
                                                    <p>How much time can you dedicate to the pet daily: </p> <span>${request.timeCommitment}</span>
                                                </div>
                                                <div>
                                                    <p>Are you financially prepared for pet care costs: </p> <span>${request.financialPrepared}</span>
                                                </div>
                                            </div>
                                        </div>  
                                    `
                                    document.querySelector(".requests").append(requestEle)
                                }).catch(error => {
                                    console.error("Error fetching requests:", error);
                                });
                        })
                    } else {
                        petRequests.map(request => {
                            if (request.authorID == userId) {
                                fetch(`http://localhost:400/users/${request.authorID}`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(`HTTP error! Status: ${response.status}`);
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log(data)
                                        const author = data
                                        const requestEle = document.createElement("div")
                                        requestEle.innerHTML = `
                                            <div class="request">
                                                <div style="display: flex ; align-items: center; justify-content: space-between;">
                                                    <div class="user" style="flex-direction: column;align-items: flex-start;">
                                                        <h3 id="requester">${author.username}</h3>
                                                        <div class="contact" style="margin-top: -10px;">
                                                            <p style="color: #4b4b4b;">Email: <span id="email" style="color: #000;">${author.email}</span>
                                                            </p>
                                                            <p style="color: #4b4b4b;">Phone: <span id="phone" style="color: #000;">${author.phone}</span></p>
                                                        </div>
                                                    </div>    
                                                    ${pet.ownerId == userId ? `
                                                        <div class="control_request">
                                                            <button>Approve</button>
                                                            <button>Denied</button>
                                                        </div>
                                                    `: ""}
                                                </div>

                                                <div class="requestCont" style="flex-direction: column;align-items: flex-start;">
                                                    <div>
                                                        <p>Are pets allowed in your residence: </p> <span>${request.petsAllowed}</span>
                                                    </div>
                                                    <div>
                                                        <p>Who else lives in your home: </p> <span >${request.household}</span>
                                                    </div>
                                                    <div>
                                                        <p>Do you currently have other pets: </p> <span>${request.otherPets}</span>
                                                    </div>
                                                    <div>
                                                        <p> How long are you available to foster: </p> <span>${request.fosterDuration}</span>
                                                    </div>
                                                
                                                    <div>
                                                        <p>Have you owned or cared for pets before: </p> <span>${request.petExperience}</span>
                                                    </div>
                                                    <div>
                                                        <p>How much time can you dedicate to the pet daily: </p> <span>${request.timeCommitment}</span>
                                                    </div>
                                                    <div>
                                                        <p>Are you financially prepared for pet care costs: </p> <span>${request.financialPrepared}</span>
                                                    </div>
                                                </div>
                                            </div>  
                                        `
                                        document.querySelector(".requests").append(requestEle)
                                    }).catch(error => {
                                        console.error("Error fetching requests:", error);
                                    });
                            }
                        })
                    }

                }).catch(error => {
                    console.error("Error fetching pets:", error);
                    const notFoundError = document.createElement("div")
                    notFoundError.innerHTML = `
                        <div id="notFoundError">
                            <h1>Pet With Id {${petId}} Can Not Be Found</h1>
                            <a href="./">Back To Home</a>
                        </div>
                    `
                    document.body.style = "overflow-y: hidden;"
                    document.body.appendChild(notFoundError)
                    console.log(document.querySelector("#notFoundError"))
                });



            let form_popup = document.querySelector("#form_popup")

            document.querySelector("#petButton").addEventListener("click", () => {
                if (userId) {
                    form_popup.classList.add("active")
                } else {
                    window.location.href = "./signup.html"
                }
            })



            document.querySelector("#form_popup #close").addEventListener("click", () => {
                form_popup.classList.remove("active")
            })

            document.querySelector("#formRequestBtn").addEventListener("click", (e) => {
                e.preventDefault()

                const petRequest = {
                    authorID: userId,
                    petsAllowed: document.getElementById("pets_allowed").value,
                    household: document.getElementById("household").value,
                    otherPets: document.getElementById("other_pets").value,
                    petExperience: document.getElementById("pet_experience").value,
                    timeCommitment: document.getElementById("time_commitment").value,
                    financialPrepared: document.getElementById("financial_prepared").value,
                    fosterDuration: document.getElementById("foster_duration")?.value || null

                }



                if (document.querySelector("#terms").checked) {
                    console.log(petRequest)

                    fetch(`http://localhost:400/addPetRequest/${petId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(petRequest)
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Success:', data)
                            if (data.updatedRequests) {
                                fetch(`http://localhost:400/users/addrequestedPet/${userId}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ id: petId })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Success:', data)
                                        if (data.updatedRequestedPets) {
                                            window.location.href = `./viewPet.html?petId=${petId}`;
                                        }
                                    }
                                    )
                                    .catch(error => console.error('Error:', error));
                                // window.location.href = `./viewPet.html?petId=${petId}`;
                            }
                        }
                        )
                        .catch(error => console.error('Error:', error));
                } else {
                    document.querySelector("#form_popup #error").classList.remove("d_none")
                }
            })
        } else {
            const notFoundError = document.createElement("div")
            notFoundError.innerHTML = `
                        <div id="notFoundError">
                            <h1>petId Can Not Be Found</h1>
                            <a href="./">Back To Home</a>
                        </div>
                    `
            document.body.style = "overflow-y: hidden;"
            document.body.appendChild(notFoundError)
            console.log(document.querySelector("#notFoundError"))
        }


    </script>
    <script src="./main.js"></script>
</body>

</html>