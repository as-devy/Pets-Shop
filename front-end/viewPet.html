<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="./imgs/favicon.ico">
    <link rel="stylesheet" href="./css/viewPet.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/icons.css">
    <title>View - </title>
</head>

<body>
    <div class="preloader">
        <img src="./imgs/preloader.gif" alt="">
    </div>
    <header>
        <div class="container">
            <div class="lg" style="width: 268px;">
                <a href="./" class="logo">
                    <img src="./imgs/logo.png" alt="pawsafe">
                    <h3>Paws Safe</h3>
                </a>
            </div>
            <ul class="nav">
                <li><a href="./index.html"><i class="fa-solid fa-house"></i> Home</a></li>
                <li><a href="./foster.html" id="fosterLink"><i class="fa-solid fa-paw"></i> Foster</a></li>
                <li><a href="./rehoming.html" id="rehomeLink"><i class="fa-solid fa-hand-holding-heart"></i>
                        Adoption</a></li>
                <li> <a href="./postpet.html" class="post_pet "><i class="fas fa-upload"></i> Post Pet </a></li>
                <li><a href="./index.html#contact_us"><i class="fas fa-phone"></i> Contact Us</a></li>
            </ul>
            <div class="auth">

                <div class="register">

                    <a href="./login.html" class="login">Login</a>
                    <a href="./signup.html" class="signup"><i class="fa-solid fa-user"></i> Sign Up</a>
                </div>

                <div style="display: flex; align-items: center; gap:1rem">
                    <button class="notif d_none" id="notif_btn"><i class="fa-solid fa-bell"></i>
                        <span class="notif_length"></span>
                    </button>

                    <div id="user_personal" class="d_none">Hi, <b id="user_name"></b> <i
                            class="fa-solid fa-caret-down"></i></div>
                </div>
                <div class="personal_info ">
                    <div class="info"><span>Email:</span> <b id="user-email"></b></div>
                    <div class="action_btns">
                        <a href="./admin_dashboard.html" id="dashboard_btn" class="verify_account d_none"><i
                                class="fa-solid fa-badge-check"></i> Dashboard</a>
                        <a href="./mypets.html" class="verify_account"><i class="fa-solid fa-paw"></i> My Pets</a>
                        <a href="./verification.html" id="get_verify_btn" class="verify_account"><i
                                class="fa-solid fa-badge-check"></i> Get
                            Verified</a>
                        <a href="#" class="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout </a>
                    </div>
                </div>
                <div class="notif_list" id="notif_list">
                    <div style="display: flex;align-items: center;justify-content: space-between;margin-bottom: 10px;">
                        <h3>Notifications</h3>
                        <a href="#" class="d_none" id="clear_notifis">Clear All</a>
                    </div>
                    <p class="info d_none" style="color: #505050;padding: 8px;">You Don't Have Notifications.</p>
                    <ul>

                    </ul>
                </div>

            </div>
        </div>
    </header>

    <main>
        <div class="petInfo">
            <div class="img" style="position: relative; overflow: hidden;">
                <img id="img" src="./imgs/adoptsingle1.jpg" alt="">
                <span class="category" id="ra">adoption</span>
            </div>
            <ul class="info">
                <li>
                    <div class="approve_pet">
                        <h1 id="name"></h1>
                        <a href="#" id="open_delete_pet_popup" class="delete_btn d_none"><i
                                class="fa-solid fa-trash"></i> Delete</a>
                    </div>
                </li>

                <li>
                    <h4 id="age"></h4>
                </li>
                <li>
                    <div class="loc">
                        <i class="fa-solid fa-location-dot"></i>
                        <span id="location"></span>
                    </div>
                </li>
                <li>
                    <div class="cat">
                        <span style="color: grey;">Category:</span>
                        <span id="cat" style="text-transform: capitalize;"></span>
                    </div>
                </li>
                <li>
                    <div class="cat">
                        <span style="color: grey;">Gender:</span>
                        <span id="gender" style="text-transform: capitalize;"></span>
                    </div>
                </li>
                <li>
                    <div class="medical_history">
                        <span style="color: grey; font-weight: bold;"> Medical history</span>
                        <div class="qa">
                            <div>
                                <p>Vaccinations: </p> <span id="vaccines_prevention"></span>
                            </div>
                            <div>
                                <p>Medical Conditions: </p> <span id="health_history"></span>
                            </div>
                            <div>
                                <p>Diet:</p> <span id="diet"></span>
                            </div>
                            <div>
                                <p>Behavior Issues:</p> <span id="behavior"></span>
                            </div>

                        </div>
                    </div>

                </li>

                <li>
                    <p id="desc"></p>
                </li>

                <li>

                    <div class="user" style="display: flex; justify-content: space-between;align-items: center;">
                        <p>This pet owenes to <span id="owenrName" style="color: #000;font-weight: bold;">
                            </span></p>
                        <button id="contact_owner" style="font-size: 16px;padding: 10px 20px;"><i
                                class="fa-solid fa-envelope"></i> Contact</button>
                    </div>
                </li>

                <!-- FOR ANY USER EXCEPT THE OWNER -->

                <li style="display: flex;align-items: center;gap: 1rem;" id="userRequest" class="d_none">
                    <button id="petButton">Adopt Pet</button>
                    <p>This pet have <span style="font-weight: bold;" id="requestsCount">0</span> requests</p>
                </li>

                <!-- FOR THE OWNER -->

                <li style="display: flex;align-items: center;gap: 1rem;" id="userIdentify" class="d_none">
                    <p id="requests_count">You have <span style="font-weight: bold;" id="requestsCount">0</span>
                        requests on this pet</p>
                </li>

                <li id="approvalPet" class="d_none">
                    <span>Pet Requested</span>
                </li>

            </ul>



        </div>


        <h1 style="width: 85%; margin: 0 auto;margin-top: 40px;">Requests</h1>
        <div class="requests">


        </div>

    </main>


    <div id="form_popup">
        <div class="content">
            <div id="close">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <h1>Request a Pet</h1>
            <form action="">

                <div class="input">
                    <label for="pets_allowed">Are pets allowed in your residence?</label>
                    <select id="pets_allowed" name="pets_allowed" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                        <option value="not_sure">Not sure</option>
                    </select>
                </div>

                <div class="input">
                    <label for="household">Who else lives in your home?</label>
                    <input type="text" id="household" name="household" placeholder="E.g., adults, children, roommates"
                        required>
                </div>

                <div class="input">
                    <label for="other_pets">Do you currently have other pets?</label>
                    <select id="other_pets" name="other_pets" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="no">No</option>
                        <option value="yes_dog">Yes, a dog</option>
                        <option value="yes_cat">Yes, a cat</option>
                        <option value="yes_other">Yes, other pets</option>
                    </select>
                </div>

                <div class="input">
                    <label for="pet_experience">Have you owned or cared for pets before?</label>
                    <select id="pet_experience" name="pet_experience" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <div class="input" id="foster-duration" style="display: none; text-align: left; ">
                    <label for="foster_duration">How long are you available to foster?</label>
                    <select id="foster_duration" name="foster_duration" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="short_term">Short-term (a few weeks)</option>
                        <option value="long_term">Long-term (several months or more)</option>
                        <option value="emergency">Emergency fostering (temporary care in urgent situations)</option>
                        <option value="not_sure">Not sure yet</option>
                    </select>
                </div>

                <div class="input">
                    <label for="time_commitment">How much time can you dedicate to the pet daily?</label>
                    <input type="text" id="time_commitment" name="time_commitment"
                        placeholder="E.g., 2-3 hours, full-time, etc." required>
                </div>

                <div class="input">
                    <label for="financial_prepared">Are you financially prepared for pet care costs?</label>
                    <select id="financial_prepared" name="financial_prepared" required>
                        <option value="" disabled selected>Select an option</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                        <option value="unsure">Unsure</option>
                    </select>
                </div>

                <!-- Terms and Conditions Section -->
                <div class="input_terms">
                    <input type="checkbox" id="terms" name="terms" required>
                    <label for="terms">
                        I agree to the <a href="terms.html" target="_blank"
                            style="color: #009fff; text-decoration: underline;">Terms and Conditions</a>
                    </label>
                </div>

                <div style="display: flex;flex-direction: column;">
                    <p id="error" class="error d_none" style="font-size: 13px;color: red;">Accept terms and conditions
                    </p>
                    <button id="formRequestBtn">Request</button>
                </div>
            </form>
        </div>
    </div>

    <div id="getVerified_popup">
        <div class="content">
            <div id="close">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <h2>You Should be Verified To Request This Pet</h2>
            <a href="./verification.html" id="get_verify_btn" class="verify_account" style="margin-top: 15px;"><i
                    class="fa-solid fa-badge-check"></i> Get
                Verified</a>
        </div>
    </div>

    <div id="contact_popup" class="">
        <div class="content">
            <div id="close">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <h2 style="display: flex ; justify-content: center; gap: .5rem;">Contact <span id="owenrName"
                    style="display: flex ; gap: .3rem;color: #000;font-weight: bold;"></span></h2>
            <form action="">
                <div class="input d_none" id="phone_input">
                    <label for="phone">Phone Number:</label>
                    <input type="text" id="owenrPhone" name="phone" class="disabled" readonly required>
                </div>

                <div class="input">
                    <label for="name">To:</label>
                    <input type="text" id="owenrEmail" name="name" class="disabled" readonly required>
                </div>

                <div class="input">
                    <label for="email">Your Email:</label>
                    <input type="email" id="userEmail" class="disabled" readonly name="email" required>
                </div>

                <div class="input">
                    <label for="subject">Subject:</label>
                    <input type="text" id="emailSubject" name="subject" required>
                </div>

                <div class="input">
                    <label for="message">Message:</label>
                    <textarea id="emailMessage" name="message" rows="5" required></textarea>
                </div>

                <button id="send_msg_to_owner">Send Message</button>
            </form>
        </div>
    </div>

    <div id="email_notice">
        <i class="fa-solid fa-check"></i>
        <h4>Email Sended Successfully</h4>
    </div>

    <div class="sureToDeletePopUp" id="delete_pet_popup">
        <div class="content">
            <h1>Sure To Delete This Pet ?</h1>
            <div class="action_btns">
                <a href="#" class="main_delete" id="delete_pet">Delete</a>
                <a href="#" id="cancel">Cancel</a>
            </div>
        </div>
    </div>

    <div class="sureToDeletePopUp" id="delete_request_popup">
        <div class="content">
            <h1>Sure To Delete Your Request ?</h1>
            <div class="action_btns">
                <a href="#" class="main_delete" id="delete_request">Delete</a>
                <a href="#" id="cancel">Cancel</a>
            </div>
        </div>
    </div>

    <script>

        function getCookie(name) {
            const cookies = document.cookie.split('; ');
            for (let cookie of cookies) {
                const [key, value] = cookie.split('=');
                if (key === name) {
                    return value;
                }
            }
            return null;
        }

        const userId = getCookie('UserId');
        let verified = false;
        const urlParams = new URLSearchParams(window.location.search);

        const petId = urlParams.get("petId");
        const requesterId = urlParams.get("requesterId");

        console.log(petId);

        if (petId) {
            fetch(`http://localhost:400/pet/${petId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data)
                    const pet = data;
                    document.title = `View - ${pet.name}`
                    document.querySelector("#name").textContent = pet.name
                    document.querySelector("#age").textContent = `${pet.age} years old `
                    document.querySelector("#desc").textContent = pet.description
                    document.querySelector("#img").src = pet.img
                    document.querySelector("#vaccines_prevention").textContent = pet.vaccines_prevention
                    document.querySelector("#health_history").textContent = pet.health_history
                    document.querySelector("#diet").textContent = pet.diet
                    document.querySelector("#behavior").textContent = pet.behavior
                    document.querySelector("#location").textContent = `${pet.city} , ${pet.country}`;
                    document.querySelector("#cat").textContent = pet.category
                    document.querySelector("#gender").textContent = pet.gender
                    document.querySelector("#ra").textContent = pet.foster ? "foster" : "Adopt"
                    const petRequests = JSON.parse(pet.requests)
                    document.querySelectorAll("#requestsCount").forEach(ele => {
                        ele.textContent = petRequests.length;
                    })

                    //get approved request on adopter id
                    if (pet.requested) {
                        petRequests.forEach(request => {
                            if (request.approved) {
                                if (request.authorID == userId){
                                    document.querySelector("#phone_input").classList.remove("d_none")
                                }
                            }
                        })
                    }



                    document.querySelector("#petButton").textContent = pet.foster ? "Foster Pet" : "Adopt Pet";

                    fetch(`http://localhost:400/users/${userId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            const user = data;
                            document.querySelector("#userEmail").value = user.email;
                            const userRequestedPets = JSON.parse(user.requestedPets);
                            userRequestedPets.forEach(requestedPetId => {
                                // if (requestedPetId == petId) {
                                //     document.querySelector("#petButton").setAttribute("disabled", true)
                                //     document.querySelector("#petButton").classList.add("disabled")
                                // }
                            })

                            // CHECK IF USER VERIFIED
                            if (user.verification_status == "approved" || user.role == 'admin') {
                                verified = true;
                            }
                        }).catch(error => {
                            console.error("Error fetching users:", error);
                        });

                    // Toggle the foster duration question based on pet type
                    const fosterQuestion = document.querySelector("#foster-duration");
                    if (pet.foster) {
                        fosterQuestion.style.display = "block"; // Show for foster
                    } else {
                        fosterQuestion.style.display = "none"; // Hide for adopt
                    }

                    // CHECK IF PET IS REQUESTED SHOW PET REQUESTED

                    if (pet.requested) {
                        document.querySelector("#approvalPet").classList.remove("d_none")
                    } else {
                        // IF NOT SHOW THE ABILITY TO REQUEST THE PET IF USER
                        if (pet.ownerId == userId) {
                            document.querySelector("#userIdentify").classList.remove("d_none")
                            document.querySelector("#contact_owner").classList.add("d_none")
                            document.querySelector("#open_delete_pet_popup").classList.remove("d_none")
                        } else {
                            // IF THE OWNER SHOW ONLY THE REQUESTES COUNT
                            document.querySelector("#userRequest").classList.remove("d_none")
                        }
                    }

                    // class actiuve added on header to highlight it deneoend on type of adoption or fostering 
                    if (pet.foster) {
                        document.querySelector("#fosterLink").classList.add("active")

                    } else if (pet.rehoming) {
                        document.querySelector("#rehomeLink").classList.add("active")
                    }

                    fetch(`http://localhost:400/users/${pet.ownerId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data)
                            const petOwner = data;
                            // SET THE OWNER NAME TO ALL ONWER NAME FILDES
                            document.querySelectorAll("#owenrName").forEach(ele => {
                                ele.textContent = petOwner.username;
                                if (petOwner.verification_status == "approved" || petOwner.role == "admin") {
                                    ele.innerHTML += `<div id='verify_icon'><i class="fa-solid fa-badge-check" style='color: var(--primary_color);'></i></div>`
                                }
                            })

                            document.querySelector("#owenrPhone").value = petOwner.phone;
                            document.querySelector("#owenrEmail").value = petOwner.email;
                        }).catch(error => {
                            console.error("Error fetching users:", error);
                        });


                    // REQUESTS FUNCTIONALLITIES
                    const approvePetFunc = () => {
                        const approvedBtns = document.querySelectorAll(".request #approveBtn");
                        // PUT CLICK EVENT ON ALL APPROVE BUTTONS IN PAGE
                        approvedBtns.forEach(btn => {
                            btn.addEventListener("click", () => {
                                // GET REQUESTER ID
                                const requestAutherId = btn.getAttribute("data-id")

                                // GET THE ACCEPTED REQUEST AND CHNAGE THE ACCEPTED VALUE TO 1
                                const updatedPetRequests = petRequests.reverse().map(item =>
                                    item.authorID === requestAutherId ? { ...item, approved: 1 } : item
                                );

                                // UPDATE THE REQUESTES OBJECT IN DATABASE
                                fetch(`http://localhost:400/updateRequest/${petId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ type: "approval", updatedRequest: updatedPetRequests })
                                }).then(response => response.json())
                                    .then(data => {
                                        console.log('Success:', data)
                                        if (data.updatedRequests) {
                                            // SEND NOTIFICATION TO USER
                                            fetch(`http://localhost:400/users/addNotification/${requestAutherId}`, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({ type: "approval", ownerUserId: pet.ownerId, PetId: petId })
                                            })
                                                .then(response => response.json())
                                                .then(data => {
                                                    if (data.updatedNotifications) {
                                                        // window.location.href = `./viewPet.html?petId=${petId}`;
                                                        console.log("Send Notifi")
                                                    }
                                                }
                                                )
                                                .catch(error => console.error('Error:', error));

                                            // REMOVE ALL CONTROLS BUTTONS ON REQUEST (Approve & Denied)
                                            document.querySelectorAll(".request .control_request").forEach(ele => {
                                                ele.remove()
                                            })

                                            // ADD PET REQUESTED ON PET
                                            document.querySelector("#approvalPet").classList.remove("d_none")
                                            document.querySelector("#userIdentify").classList.add("d_none")

                                            // ADD Approved TEXT ON REQUEST
                                            const approvedDiv = document.createElement("div")
                                            approvedDiv.classList.add("approved")
                                            approvedDiv.innerHTML = `<h5><i class="fa-solid fa-check"></i> Approved</h5>`
                                            // document.querySelector(`.request[data-id="${requestAutherId}"] .request_head`).appendChild(approvedDiv)
                                            if (!document.querySelector(`.request[data-id="${requestAutherId}"] .request_head .approved`)) {
                                                document.querySelector(`.request[data-id="${requestAutherId}"] .request_head`).appendChild(approvedDiv)
                                            }
                                        }
                                    }).catch(error => console.error('Error:', error));
                            })
                        })
                    }

                    const deniedPetFunc = () => {
                        const deniedBtn = document.querySelectorAll(".request #deniedBtn");
                        // PUT CLICK EVENT ON ALL DENIED BUTTONS IN PAGE
                        deniedBtn.forEach(btn => {
                            btn.addEventListener("click", () => {
                                // GET REQUESTER ID
                                const requestAutherId = btn.getAttribute("data-id")

                                // GET THE DENIED REQUEST AND CHNAGE THE DENIED VALUE TO 1
                                const updatedPetRequests = petRequests.reverse().map(item =>
                                    item.authorID === requestAutherId ? { ...item, denied: 1 } : item
                                );

                                // UPDATE THE REQUESTES OBJECT IN DATABASE
                                fetch(`http://localhost:400/updateRequest/${petId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ updatedRequest: updatedPetRequests })
                                }).then(response => response.json())
                                    .then(data => {
                                        console.log('Success:', data)
                                        if (data.updatedRequests) {
                                            // SEND NOTIFICATION TO USER
                                            fetch(`http://localhost:400/users/addNotification/${requestAutherId}`, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({ type: "denied", ownerUserId: pet.ownerId, PetId: petId })
                                            })
                                                .then(response => response.json())
                                                .then(data => {
                                                    console.log('Success:', data)
                                                    if (data.updatedNotifications) {
                                                        // window.location.href = `./viewPet.html?petId=${petId}`;
                                                        console.log("Send Notifi")
                                                    }
                                                }
                                                )
                                                .catch(error => console.error('Error:', error));

                                            // ADD DENIED TEXT ON REQUEST
                                            const deniedDiv = document.createElement("div")
                                            deniedDiv.classList.add("denied")
                                            deniedDiv.innerHTML = `<h5><i class="fa-solid fa-x"></i> Denied</h5>`
                                            // document.querySelector(`.request[data-id="${requestAutherId}"] .request_head`).appendChild(deniedDiv)
                                            if (!document.querySelector(`.request[data-id="${requestAutherId}"] .request_head .denied`)) {
                                                document.querySelector(`.request[data-id="${requestAutherId}"] .request_head`).appendChild(deniedDiv)
                                            }
                                        }
                                    }).catch(error => console.error('Error:', error));
                            })
                        })
                    }

                    // fetching requests 
                    if (userId == pet.ownerId) {
                        petRequests.map(request => {
                            fetch(`http://localhost:400/users/${request.authorID}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! Status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log(data)
                                    const author = data
                                    const requestEle = document.createElement("div")
                                    requestEle.innerHTML = `
                                        <div class="request ${request.approved ? "approved_request" : ""}" data-id="${request.authorID}">
                                            <div class="request_head" style="display: flex ; align-items: center; justify-content: space-between;">
                                                <div class="user" style="flex-direction: column;align-items: flex-start;">
                                                    <h3 id="requester">${author.username}</h3>
                                                    <div class="contact" style="margin-top: -10px;">
                                                        <p style="color: #4b4b4b;">Email: <span id="email" style="color: #000;">${author.email}</span>
                                                        </p>
                                                        <p style="color: #4b4b4b;">Phone: <span id="phone" style="color: #000;">${author.phone}</span></p>
                                                    </div>
                                                </div>    
                                                ${pet.ownerId == userId && !pet.requested && !request.denied ? `
                                                    <div class="control_request">
                                                        <button id="approveBtn" data-id="${request.authorID}">Approve</button>
                                                        <button id="deniedBtn" data-id="${request.authorID}">Denied</button>
                                                    </div>
                                                `: ""}

                                                ${request.approved ? `<div class="approved"><h5><i class="fa-solid fa-check"></i> Approved</h5></div>` : ""}
                                                ${request.denied ? `<div class="denied"><h5><i class="fa-solid fa-x"></i> Denied</h5></div>` : ""}
                                            </div>

                                            <div class="requestCont" style="flex-direction: column;align-items: flex-start;">
                                                <div>
                                                    <p>Are pets allowed in your residence: </p> <span>${request.petsAllowed}</span>
                                                </div>
                                                <div>
                                                    <p>Who else lives in your home: </p> <span >${request.household}</span>
                                                </div>
                                                <div>
                                                    <p>Do you currently have other pets: </p> <span>${request.otherPets}</span>
                                                </div>
                                                <div>
                                                    <p> How long are you available to foster: </p> <span>${request.fosterDuration}</span>
                                                </div>
                                            
                                                <div>
                                                    <p>Have you owned or cared for pets before: </p> <span>${request.petExperience}</span>
                                                </div>
                                                <div>
                                                    <p>How much time can you dedicate to the pet daily: </p> <span>${request.timeCommitment}</span>
                                                </div>
                                                <div>
                                                    <p>Are you financially prepared for pet care costs: </p> <span>${request.financialPrepared}</span>
                                                </div>
                                            </div>
                                        </div>  
                                    `
                                    document.querySelector(".requests").append(requestEle)

                                    // MAKE THE APPROVED REQUEST BE THE FIRST REUQEST TO BE VIWED
                                    if (document.querySelector(".requests .approved_request")) {
                                        document.querySelector(".requests").prepend(document.querySelector(".approved_request").parentElement)
                                    }

                                    // SCROLL INTO THE REQUESTERID REQUEST IF EXIST
                                    if (requesterId) {
                                        const requestedRequest = document.querySelector(`.request[data-id="${requesterId}"]`);
                                        if (requestedRequest) {
                                            requestedRequest.scrollIntoView({ behavior: 'smooth', block: "center" })
                                            requestedRequest.classList.add("light")
                                        }
                                    }

                                    approvePetFunc()
                                    deniedPetFunc()
                                }).catch(error => {
                                    console.error("Error fetching requests:", error);
                                });
                        })
                    } else {
                        petRequests.map(request => {
                            if (request.authorID == userId) {
                                fetch(`http://localhost:400/users/${request.authorID}`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(`HTTP error! Status: ${response.status}`);
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log(data)
                                        const author = data
                                        const requestEle = document.createElement("div")
                                        requestEle.innerHTML = `
                                            <div class="request" data-id="${request.authorID}">
                                                <div class="request_head" style="display: flex ; align-items: center; justify-content: space-between;">
                                                    <div class="user" style="flex-direction: column;align-items: flex-start;">
                                                        <h3 id="requester">${author.username}</h3>
                                                        <div class="contact" style="margin-top: -10px;">
                                                            <p style="color: #4b4b4b;">Email: <span id="email" style="color: #000;">${author.email}</span>
                                                            </p>
                                                            <p style="color: #4b4b4b;">Phone: <span id="phone" style="color: #000;">${author.phone}</span></p>
                                                        </div>
                                                    </div>  

                                                    ${!request.approved && !request.denied ? `<a href="#" id="open_delete_request_popup" class="delete_btn" data-id="${request.authorID}"><i class="fa-solid fa-trash"></i> Delete</a>` : ""}

                                                    ${request.approved ? `<div class="approved"><h5><i class="fa-solid fa-check"></i> Approved -> Contact Owner</h5></div>` : ""}
                                                    ${request.denied ? `<div class="denied"><h5><i class="fa-solid fa-x"></i> Denied</h5></div>` : ""}
                                                </div>

                                                <div class="requestCont" style="flex-direction: column;align-items: flex-start;">
                                                    <div>
                                                        <p>Are pets allowed in your residence: </p> <span>${request.petsAllowed}</span>
                                                    </div>
                                                    <div>
                                                        <p>Who else lives in your home: </p> <span >${request.household}</span>
                                                    </div>
                                                    <div>
                                                        <p>Do you currently have other pets: </p> <span>${request.otherPets}</span>
                                                    </div>
                                                    <div>
                                                        <p> How long are you available to foster: </p> <span>${request.fosterDuration}</span>
                                                    </div>
                                                
                                                    <div>
                                                        <p>Have you owned or cared for pets before: </p> <span>${request.petExperience}</span>
                                                    </div>
                                                    <div>
                                                        <p>How much time can you dedicate to the pet daily: </p> <span>${request.timeCommitment}</span>
                                                    </div>
                                                    <div>
                                                        <p>Are you financially prepared for pet care costs: </p> <span>${request.financialPrepared}</span>
                                                    </div>
                                                </div>
                                            </div>  
                                        `
                                        document.querySelector(".requests").append(requestEle)

                                        const sureToDeleteRequestPopUp = document.querySelector("#delete_request_popup")

                                        // OPEN DELETE REQUEST POP UP
                                        const open_delete_request_popup = document.querySelector("#open_delete_request_popup")
                                        if (open_delete_request_popup) {
                                            open_delete_request_popup.addEventListener("click", (e) => {
                                                e.preventDefault()
                                                sureToDeleteRequestPopUp.classList.add("active")
                                                const requestAutherId = open_delete_request_popup.getAttribute("data-id");
                                                sureToDeleteRequestPopUp.querySelector("#delete_request").setAttribute("data-requestAutherId", requestAutherId)
                                            })
                                        }

                                        // DELETE PET REQUEST
                                        const deleteRequestBtn = document.querySelector("#delete_request");
                                        deleteRequestBtn.addEventListener("click", () => {
                                            const requestId = deleteRequestBtn.getAttribute("data-requestAutherId")

                                            const updatedPetRequests = petRequests.filter(item => item.authorID !== requestId);
                                            // UPDATE THE REQUESTES OBJECT IN DATABASE
                                            fetch(`http://localhost:400/removePetRequest/${petId}`, {
                                                method: 'PUT',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({ petOwnerId: pet.ownerId, requestAuthorId: requestId, updatedRequest: updatedPetRequests })
                                            }).then(response => response.json())
                                                .then(data => {
                                                    if (data.updatedRequestedPets) {
                                                        window.location.reload()
                                                    }
                                                }).catch(error => console.error('Error:', error));
                                        })

                                        // CANCEL REQUEST DELETION
                                        document.querySelector("#delete_request_popup #cancel").addEventListener("click", () => {
                                            sureToDeleteRequestPopUp.classList.remove("active")
                                        })
                                    }).catch(error => {
                                        console.error("Error fetching requests:", error);
                                    });
                            }
                        })
                    }

                    const formRequestBtn = document.querySelector("#formRequestBtn")
                    formRequestBtn.addEventListener("click", (e) => {
                        e.preventDefault()

                        const petRequest = {
                            authorID: userId,
                            petsAllowed: document.getElementById("pets_allowed").value,
                            household: document.getElementById("household").value,
                            otherPets: document.getElementById("other_pets").value,
                            petExperience: document.getElementById("pet_experience").value,
                            timeCommitment: document.getElementById("time_commitment").value,
                            financialPrepared: document.getElementById("financial_prepared").value,
                            fosterDuration: document.getElementById("foster_duration")?.value || null,
                            approved: 0,
                            denied: 0,
                        }

                        if (document.querySelector("#terms").checked) {
                            console.log(petRequest)
                            formRequestBtn.innerHTML = "Requesting..."
                            formRequestBtn.setAttribute("disabled", true)
                            formRequestBtn.classList.add("disabled")

                            fetch(`http://localhost:400/addPetRequest/${petId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(petRequest)
                            }).then(response => response.json())
                                .then(data => {
                                    console.log('Success:', data)
                                    if (data.updatedRequests) {
                                        fetch(`http://localhost:400/users/addrequestedPet/${userId}`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({ id: petId })
                                        })
                                            .then(response => response.json())
                                            .then(data => {
                                                console.log('Success:', data)
                                                if (data.updatedRequestedPets) {
                                                    fetch(`http://localhost:400/users/addNotification/${pet.ownerId}`, {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json'
                                                        },
                                                        body: JSON.stringify({ requestedUserId: userId, requestedPetId: petId })
                                                    })
                                                        .then(response => response.json())
                                                        .then(data => {
                                                            console.log('Success:', data)
                                                            if (data.updatedNotifications) {
                                                                window.location.href = `./viewPet.html?petId=${petId}`;
                                                            }
                                                        }
                                                        )
                                                        .catch(error => console.error('Error:', error));

                                                }
                                            }
                                            )
                                            .catch(error => console.error('Error:', error));

                                    }
                                }
                                ).catch(error => console.error('Error:', error));
                        } else {
                            document.querySelector("#form_popup #error").classList.remove("d_none")
                        }
                    })


                }).catch(error => {
                    console.error("Error fetching pets:", error);
                    const notFoundError = document.createElement("div")
                    notFoundError.innerHTML = `
                        <div id="notFoundError">
                            <h1>Pet With Id {${petId}} Can Not Be Found</h1>
                            <a href="./">Back To Home</a>
                        </div>
                    `
                    document.body.style = "overflow-y: hidden;"
                    document.body.appendChild(notFoundError)
                    console.log(document.querySelector("#notFoundError"))
                });



            const sureToDeletePetPopUp = document.querySelector("#delete_pet_popup")
            // OPEN DELETE PET POP UP
            document.querySelector("#open_delete_pet_popup").addEventListener("click", () => {
                sureToDeletePetPopUp.classList.add("active")
            })

            // DELETE PET
            document.querySelector("#delete_pet").addEventListener("click", () => {
                fetch(`http://localhost:400/pet/${petId}`, {
                    method: 'DELETE',
                }).then(response => {
                    if (response.ok) {
                        window.location.href = './foster.html';
                    }
                }).catch(error => {
                    console.error('Error deleting pet:', error);
                });
            })

            // CANCEL PET DELETION
            document.querySelector("#delete_pet_popup #cancel").addEventListener("click", () => {
                sureToDeletePetPopUp.classList.remove("active")
            })

            let getVerified_popup = document.querySelector("#getVerified_popup")
            let form_popup = document.querySelector("#form_popup")
            let contact_popup = document.querySelector("#contact_popup")

            // OPENS REQUEST FORM POPUP
            document.querySelector("#petButton").addEventListener("click", () => {
                if (userId) {
                    if (verified) {
                        form_popup.classList.add("active")
                    } else {
                        getVerified_popup.classList.add("active")
                    }
                } else {
                    window.location.href = "./signup.html"
                }
            })

            // CLOSE REQUEST FORM POPUP
            document.querySelector("#form_popup #close").addEventListener("click", () => {
                form_popup.classList.remove("active")
            })

            // CLOSE GET VERIFIED POPUP
            document.querySelector("#getVerified_popup #close").addEventListener("click", () => {
                getVerified_popup.classList.remove("active")
            })

            // OPENS CONTACT FORM POPUP
            document.querySelector("#contact_owner").addEventListener("click", () => {
                if (userId) {
                    if (verified) {
                        contact_popup.classList.add("active")
                    } else {
                        getVerified_popup.classList.add("active")
                    }
                } else {
                    window.location.href = "./signup.html"
                }
            })

            // CLOSE CONTACT FORM POPUP
            document.querySelector("#contact_popup #close").addEventListener("click", () => {
                contact_popup.classList.remove("active")
            })

            // SEND EMAIL
            document.querySelector("#send_msg_to_owner").addEventListener("click", (e) => {
                e.preventDefault()
                document.querySelector("#send_msg_to_owner").textContent = "Sending Message..."
                document.querySelector("#send_msg_to_owner").setAttribute("disabled", true)
                document.querySelector("#send_msg_to_owner").classList.add("disabled")
                fetch("http://localhost:400/sendEmail", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        to: document.querySelector("#owenrEmail").value,
                        from: document.querySelector("#userEmail").value,
                        subject: document.querySelector("#emailSubject").value,
                        text: document.querySelector("#emailMessage").value,
                    })
                }).then(response => response.json())
                    .then(data => {
                        if (data.sended) {
                            contact_popup.classList.remove("active")
                            document.querySelector("#email_notice").classList.add("active")
                            document.querySelector("#send_msg_to_owner").textContent = "Send Message"
                            setTimeout(() => {
                                document.querySelector("#email_notice").classList.remove("active")
                            }, 5000)
                        }
                    }).catch(error => console.error("Error:", error));
            })

        } else {
            const notFoundError = document.createElement("div")
            notFoundError.innerHTML = `
                        <div id="notFoundError">
                            <h1>petId Can Not Be Found</h1>
                            <a href="./">Back To Home</a>
                        </div>
                    `
            document.body.style = "overflow-y: hidden;"
            document.body.appendChild(notFoundError)
            console.log(document.querySelector("#notFoundError"))
        }


    </script>
    <script src="./main.js"></script>
</body>

</html>