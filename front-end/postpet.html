<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/icons.css">
    <!-- <link rel="stylesheet" href="./css/home.css"> -->
    <link rel="stylesheet" href="./css/postpet.css">

    <title>Paws Safe - Post Pet</title>
</head>

<body>

    <header>
        <div class="container">
            <div class="lg" style="width: 268px;">
                <a href="./" class="logo">
                    <img src="./imgs/logo.png" alt="pawsafe">
                    <h3>Paws Safe</h3>
                </a>
            </div>
            <ul class="nav">
                <li><a class="active" href="./index.html">Home</a></li>
                <li><a href="./foster.html">Foster</a></li>
                <li><a href="#">ReHoming</a></li>
                <li><a href="./contactus.html">Contact Us</a></li>
            </ul>
            <div class="auth">
                <div class="register">
                    <a href="./login.html" class="login">Login</a>
                    <a href="./signup.html" class="signup"><i class="fa-solid fa-user"></i> Sign Up</a>
                </div>

                <a href="./postpet.html" class="post_pet d_none"><i class="fa-solid fa-paw"></i> Post Your Pet </a>
                <a href="#" class="logout d_none"><i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            </div>
        </div>

    </header>

    <main>
        <div class="form">
            <div class="form-container">

                <form>
                    <h2><i class="fa-solid fa-paw"></i> Post Your Pet</h2>

                    <div class="pet_img">
                        <input id="pet_img_input" type="file" accept="image/*" hidden>
                        <div class="input">
                            <img id="pet_img" style="display: none;"
                                src="https://images.pexels.com/photos/208773/pexels-photo-208773.jpeg" alt="">
                            <img class="icon" src="./imgs/image-gallery.png" alt="">
                        </div>
                        <p id="fileName">Add Your Pet Photo</p>
                    </div>

                    <label for="">Rehome or Foster This Pet:</label>
                    <div class="custom-select">
                        <select id="rehomeFosterSelection">
                            <option value="">Rehome or Foster This Pet</option>
                            <option value="rehome">rehome</option>
                            <option value="foster">foster</option>
                        </select>
                    </div>
                    <div class="name_age">
                        <div>
                            <label for="name">Name</label>
                            <input type="text" id="petName" name="name" required>
                        </div>

                        <div><label for="age">Age</label>
                            <input type="number" id="petAge" name="Age" required>
                        </div>

                    </div>

                    <label for="">Category</label>
                    <div class="custom-select">
                        <select id="petCategory">
                            <option value="">Choose pet category </option>
                            <option value="dog">dog</option>
                            <option value="cat">cat</option>
                            <option value="rabbit">rabbit</option>
                            <option value="bird">bird</option>
                            <option value="fish">fish</option>
                            <option value="other">other</option>
                        </select>
                    </div>

                    <label for="address">Address</label>
                    <div class="address">
                    <input type="text" id="country" name="Address" required placeholder="Country" style="margin-bottom:10px;">
                    <input type="text" id="streetAddress" name="Address" required placeholder="Street Address"
                        style="margin-bottom:10px;">
                    </div>
                    <div class="address">
                        <input type="text" id="cityAddress" name="Address" required placeholder="Town/City">
                        <input type="text" id="postCode" name="Address" required placeholder="Post Code">
                    </div>



                    <label for="medicalHistory">Medical history</label>
                    <div class="medical_history">
                        <textarea name="vaccinations" id="vaccines_prevention"
                            placeholder="Is your pet up to date on vaccinations and treatments like flea, tick, or heartworm prevention?"></textarea>
                        <textarea name="medicalHistory" id="health_history"
                            placeholder="Does your pet have any medical conditions, surgeries, or past injuries?"></textarea>
                        <textarea name="diet" id="diet"
                            placeholder="What is your petâ€™s diet, and any food issues or restrictions?"></textarea>
                        <textarea name="behavior" id="behavior"
                            placeholder="Does your pet have any behavior problems, like anxiety or aggression?"></textarea>

                    </div>

                    <label for="Description">Description:</label>
                    <textarea id="description" name="Description" rows="4" required></textarea>

                    <button type="submit" id="submit_btn">Send</button>
                </form>
            </div>

            <!-- <div class="image-container">
                <img src="./imgs/faq.webp" alt="Dog and Cat">
            </div> -->
        </div>


    </main>

    <script>
        const pet_img_ele = document.querySelector(".pet_img .input")
        const pet_img_input = document.querySelector(".pet_img #pet_img_input")

        let petImg;
        pet_img_ele.addEventListener("click", () => {
            pet_img_input.click()
            pet_img_input.addEventListener("change", function (event) {
                const file = event.target.files[0]; // Get the selected file
                if (file) {
                    const fileName = file.name;
                    function shortenFileName(filename) {
                        const lastDotIndex = filename.lastIndexOf(".");

                        if (lastDotIndex === -1) {
                            return filename.length > 20 ? filename.slice(0, 20) + "..." : filename;
                        }

                        const namePart = filename.slice(0, lastDotIndex); // File name without extension
                        const extension = filename.slice(lastDotIndex); // File extension

                        return namePart.length > 20 ? namePart.slice(0, 20) + "..." + extension : filename;
                    }
                    document.querySelector(".pet_img #fileName").textContent = shortenFileName(fileName);

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = function (e) {
                        document.querySelector(".pet_img #pet_img").src = e.target.result
                        document.querySelector(".pet_img #pet_img").style = `display: block`
                        document.querySelector(".pet_img .icon").style = `display: none`

                        const base64Image = reader.result.split(',')[1]; // Remove data URL prefix

                        const formData = new FormData();
                        formData.append("key", "2750377068f6e1a5530b8e8e9a5d522b");
                        formData.append("image", base64Image);

                        fetch("https://api.imgbb.com/1/upload", {
                            method: "POST",
                            body: formData
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    petImg = data.data.url
                                } else {
                                    console.log("Upload failed!")
                                }
                            })
                            .catch(error => {
                                console.error("Upload Error:", error);
                            });
                    };

                } else {
                    document.getElementById("fileName").textContent = "No file selected.";
                }
            });
        })

        let rehome = 0;
        let foster = 0;

        document.querySelector("#rehomeFosterSelection").addEventListener("change", (event) => {
            if (event.target.value == "rehome") {
                rehome = 1
            } else {
                foster = 1
            }
        });

        let petCategory = "";

        document.querySelector("#petCategory").addEventListener("change", (event) => {
            petCategory = event.target.value
        });

        document.querySelector("#submit_btn").addEventListener("click", (e) => {
            e.preventDefault()
            const petName = document.querySelector("#petName").value;
            const petAge = document.querySelector("#petAge").value;

            const country = document.querySelector("#country").value
            const streetAdress = document.querySelector("#streetAddress").value
            const cityAddress = document.querySelector("#cityAddress").value
            const postCode = document.querySelector("#postCode").value

            const vaccines_prevention = document.querySelector("#vaccines_prevention").value
            const health_history = document.querySelector("#health_history").value
            const diet = document.querySelector("#diet").value
            const behavior = document.querySelector("#behavior").value
            const description = document.querySelector("#description").value

            function getCookie(name) {
                const cookies = document.cookie.split('; ');
                for (let cookie of cookies) {
                    const [key, value] = cookie.split('=');
                    if (key === name) {
                        return value;
                    }
                }
                return null; // Return null if the cookie is not found
            }

            const userId = getCookie('UserId');

            const userPetInfo = {
                ownerId: userId,
                img: petImg,
                rehoming: rehome,
                foster: foster,
                name: petName,
                age: petAge,
                category: petCategory,
                country: country,
                streetAddress: streetAdress,
                city: cityAddress,
                postCode: postCode,
                vaccines_prevention: vaccines_prevention,
                health_history: health_history,
                diet: diet,
                behavior: behavior,
                description: description,
                requests: [],
            }

            console.log(userPetInfo)

            fetch('http://localhost:400/addPet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userPetInfo)
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data)
                    if (data.petId){
                        window.location.href = "./rehoming.html";
                    }
                }
                )
                .catch(error => console.error('Error:', error));
        })
    </script>
    <script src="./main.js"></script>
</body>

</html>