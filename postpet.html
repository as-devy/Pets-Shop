<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="./imgs/favicon.ico">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/icons.css">
    <!-- <link rel="stylesheet" href="./css/home.css"> -->
    <link rel="stylesheet" href="./css/postpet.css">

    <title>Paws Safe - Post Pet</title>
</head>

<body>
    <div class="preloader">
        <img src="./imgs/preloader.gif" alt="">
    </div>
    <header>
        <div class="container">
            <div class="lg" style="width: 268px;">
                <a href="./" class="logo">
                    <img src="./imgs/logo.png" alt="pawsafe">
                    <h3>Paws Safe</h3>
                </a>
            </div>
            <ul class="nav">
                <li><a href="./index.html"><i class="fa-solid fa-house"></i> Home</a></li>
                <li><a href="./foster.html"><i class="fa-solid fa-paw"></i> Foster</a></li>
                <li><a href="./rehoming.html"><i class="fa-solid fa-hand-holding-heart"></i> Adoption</a></li>
                <li> <a class="active" href="./postpet.html" class="post_pet "><i class="fas fa-upload"></i> Post Pet
                    </a></li>
                <li><a href="./index.html#contact_us"><i class="fas fa-phone"></i> Contact Us</a></li>
            </ul>
            <div class="auth">

                <div class="register">

                    <a href="./login.html" class="login">Login</a>
                    <a href="./signup.html" class="signup"><i class="fa-solid fa-user"></i> Sign Up</a>
                </div>

                <div style="display: flex; align-items: center; gap:1rem">
                    <button class="notif d_none" id="notif_btn"><i class="fa-solid fa-bell"></i>
                        <span class="notif_length"></span>
                    </button>

                    <div id="user_personal" class="d_none">Hi, <b id="user_name"></b> <i
                            class="fa-solid fa-caret-down"></i></div>
                </div>
                <div class="personal_info ">
                    <div class="info"><span>Email:</span> <b id="user-email"></b></div>
                    <div class="action_btns">
                        <a href="./admin_dashboard.html" id="dashboard_btn" class="verify_account d_none"><i
                                class="fa-solid fa-badge-check"></i> Dashboard</a>
                        <a href="./mypets.html" class="verify_account"><i class="fa-solid fa-paw"></i> My Pets</a>
                        <a href="./verification.html" id="get_verify_btn" class="verify_account"><i
                                class="fa-solid fa-badge-check"></i> Get
                            Verified</a>
                        <a href="#" class="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout </a>
                    </div>
                </div>
                <div class="notif_list" id="notif_list">
                    <div style="display: flex;align-items: center;justify-content: space-between;margin-bottom: 10px;">
                        <h3>Notifications</h3>
                        <a href="#" class="d_none" id="clear_notifis">Clear All</a>
                    </div>
                    <p class="info d_none" style="color: #505050;padding: 8px;">You Don't Have Notifications.</p>
                    <ul>

                    </ul>
                </div>

            </div>
        </div>
    </header>

    <main>
        <div class="form">
            <div class="form-container">

                <form>
                    <h2><i class="fa-solid fa-paw"></i> Post Your Pet</h2>

                    <div class="pet_img">
                        <input id="pet_img_input" type="file" accept="image/*" hidden>
                        <div class="input">
                            <img id="pet_img" style="display: none;"
                                src="https://images.pexels.com/photos/208773/pexels-photo-208773.jpeg" alt="">
                            <img class="icon" src="./imgs/image-gallery.png" alt="">
                        </div>
                        <p id="fileName">Add Your Pet Photo</p>
                    </div>

                    <label for="">Are you posting this pet for adoption or foster care:</label>
                    <div class="custom-select" style="width:auto">
                        <select id="rehomeFosterSelection">
                            <option value="" disabled selected hidden>Select Adoption or Foster</option>
                            <option value="rehome">Adoption</option>
                            <option value="foster">foster</option>
                        </select>
                    </div>
                    <div class="name_age">
                        <div>
                            <label for="name">Name</label>
                            <input type="text" id="petName" name="name" required>
                        </div>

                        <div><label for="age">Age</label>
                            <input type="number" id="petAge" name="Age" required>
                        </div>

                    </div>
                    <div class="gender_type">

                        <div>
                            <label for="petGender">Gender</label>
                            <div class="custom-select">
                                <select id="petGender" required>
                                    <option value="" disabled selected hidden>Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="">Category</label>
                            <div class="custom-select">
                                <select id="petCategory">
                                    <option value="" disabled selected hidden>Choose pet category </option>
                                    <option value="dog">dog</option>
                                    <option value="cat">cat</option>
                                    <option value="rabbit">rabbit</option>
                                    <option value="bird">bird</option>
                                    <option value="fish">fish</option>
                                    <option value="other">other</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <label for="address">Address</label>
                    <div class="address">
                        <div class="custom-select" style="width: 100%; margin-bottom: 10px;">
                            <select id="countrySelection">
                                <option value="all" selected>All Countries</option>
                            </select>
                        </div>
                        <input type="text" id="streetAddress" name="Address" required placeholder="Street Address"
                            style="margin-bottom:10px;">
                    </div>
                    <div class="address">
                        <input type="text" id="cityAddress" name="Address" required placeholder="Town/City">
                        <input type="text" id="postCode" name="Address" required placeholder="Post Code">
                    </div>

                    <!-- <label  for="spayNeuter">Has your pet been spayed or neutered?</label>
                    <div class="custom-select"  style="width:auto">
                        <select id="spayNeuter" required>
                            <option value="" disabled selected hidden>Select an option</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                            <option value="unknown">Not Sure</option>
                        </select>
                    </div> -->


                    <label for="medicalHistory">Medical history</label>
                    <div class="medical_history">
                        <textarea name="vaccinations" id="vaccines_prevention"
                            placeholder="Is your pet up to date on vaccinations and treatments like flea, tick, or heartworm prevention?"></textarea>
                        <textarea name="medicalHistory" id="health_history"
                            placeholder="Does your pet have any medical conditions, surgeries, or past injuries?"></textarea>
                        <textarea name="diet" id="diet"
                            placeholder="What is your petâ€™s diet, and any food issues or restrictions?"></textarea>
                        <textarea name="behavior" id="behavior"
                            placeholder="Does your pet have any behavior problems, like anxiety or aggression?"></textarea>

                    </div>



                    <label for="Description">Description:</label>
                    <textarea id="description" name="Description" rows="4" required></textarea>
                    <div class="emergency">
                        <label for="" style="font-weight: bold;">Is this pet in urgent need of Adoption or Foster care?
                        </label>
                        <input id="emergencyCheck" type="checkbox">
                    </div>


                    <button type="submit" id="submit_btn">Send</button>

                </form>
            </div>

            <!-- <div class="image-container">
                <img src="./imgs/faq.webp" alt="Dog and Cat">
            </div> -->
        </div>

        <div id="getVerified_popup">
            <div class="content">
                <h2>You Should be Verified To Post A Pet</h2>
                <a href="./verification.html" id="get_verify_btn" class="verify_account" style="margin-top: 15px;"><i
                        class="fa-solid fa-badge-check"></i> Get
                    Verified</a>
            </div>
        </div>
    </main>
    <script type="module" src="./js/countries.js"></script>

    <script type="module">
        import countries from "./js/countries.js"


        function getCookie(name) {
            const cookies = document.cookie.split('; ');
            for (let cookie of cookies) {
                const [key, value] = cookie.split('=');
                if (key === name) {
                    return value;
                }
            }
            return null;
        }
        const userId = getCookie('UserId');

        if (!userId) {
            window.location.href = "./signup.html"
        }

        const getVerified_popup = document.querySelector("#getVerified_popup")
        fetch(`https://pawssafe.ddns.net/users/${userId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const user = data;
                if (!(user.verification_status == "approved" || user.role == 'admin')) {
                    getVerified_popup.classList.add("active")
                }
            }).catch(error => {
                console.error("Error fetching users:", error);
            });

        
        const pet_img_ele = document.querySelector(".pet_img .input")
        const pet_img_input = document.querySelector(".pet_img #pet_img_input")


        let base64Image;


        pet_img_ele.addEventListener("click", () => {
            pet_img_input.click()
            pet_img_input.addEventListener("change", function (event) {
                const file = event.target.files[0]; // Get the selected file
                if (file) {
                    const fileName = file.name;
                    function shortenFileName(filename) {
                        const lastDotIndex = filename.lastIndexOf(".");

                        if (lastDotIndex === -1) {
                            return filename.length > 20 ? filename.slice(0, 20) + "..." : filename;
                        }

                        const namePart = filename.slice(0, lastDotIndex); // File name without extension
                        const extension = filename.slice(lastDotIndex); // File extension

                        return namePart.length > 20 ? namePart.slice(0, 20) + "..." + extension : filename;
                    }
                    document.querySelector(".pet_img #fileName").textContent = shortenFileName(fileName);

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = function (e) {
                        document.querySelector(".pet_img #pet_img").src = e.target.result
                        document.querySelector(".pet_img #pet_img").style = `display: block`
                        document.querySelector(".pet_img .icon").style = `display: none`

                        base64Image = reader.result.split(',')[1]; // Remove data URL prefix
                    };

                } else {
                    document.getElementById("fileName").textContent = "No file selected.";
                }
            });
        })

        countries.forEach(country => {
            document.querySelector("#countrySelection").innerHTML += `<option value="${country.toLowerCase()}">${country}</option>`
        });






        document.querySelector("#submit_btn").addEventListener("click", (e) => {
            e.preventDefault()
            let rehome = 0;
            let foster = 0;
            const typeSelection = document.querySelector("#rehomeFosterSelection").value;
            if (typeSelection == "rehome") {
                rehome = 1
            } else {
                foster = 1
            }
            const petCategory = document.querySelector("#petCategory").value;
            const petName = document.querySelector("#petName").value;
            const petAge = document.querySelector("#petAge").value;
            const petGender = document.querySelector("#petGender").value;

            const country = document.querySelector("#countrySelection").value
            const streetAdress = document.querySelector("#streetAddress").value
            const cityAddress = document.querySelector("#cityAddress").value

            const postCode = document.querySelector("#postCode").value

            const vaccines_prevention = document.querySelector("#vaccines_prevention").value
            const health_history = document.querySelector("#health_history").value
            const diet = document.querySelector("#diet").value
            const behavior = document.querySelector("#behavior").value
            const description = document.querySelector("#description").value
            const emergency = document.querySelector("#emergencyCheck").checked ? 1 : 0

            // console.log("emergency", emergency)


            function getCookie(name) {
                const cookies = document.cookie.split('; ');
                for (let cookie of cookies) {
                    const [key, value] = cookie.split('=');
                    if (key === name) {
                        return value;
                    }
                }
                return null; // Return null if the cookie is not found
            }

            const userId = getCookie('UserId');

            const formData = new FormData();
            formData.append("key", "2750377068f6e1a5530b8e8e9a5d522b");
            formData.append("image", base64Image);

            fetch("https://api.imgbb.com/1/upload", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let petImg = data.data.url
                        const userPetInfo = {
                            ownerId: userId,
                            img: petImg,
                            rehoming: rehome,
                            foster: foster,
                            emergency: emergency,
                            name: petName,
                            age: petAge,
                            category: petCategory,
                            gender: petGender,
                            country: country,
                            streetAddress: streetAdress,
                            city: cityAddress,
                            postCode: postCode,
                            vaccines_prevention: vaccines_prevention,
                            health_history: health_history,
                            diet: diet,
                            behavior: behavior,
                            description: description,
                            requests: [],
                        }

                        console.log(userPetInfo)

                        fetch('https://pawssafe.ddns.net/addPet', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(userPetInfo)
                        })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Success:', data)
                                if (data.petId) {

                                    if (rehome) {
                                        window.location.href = "./rehoming.html";
                                    } else if (foster) {
                                        window.location.href = "./foster.html";
                                    }

                                }
                            }
                            )
                            .catch(error => console.error('Error:', error));
                    } else {
                        console.log("Upload failed!")
                    }
                })
                .catch(error => {
                    console.error("Upload Error:", error);
                });


        })
    </script>
    <script src="./main.js"></script>
</body>

</html>